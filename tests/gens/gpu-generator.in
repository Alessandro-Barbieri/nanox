#!/bin/bash

# Transforms a text so that it is valid
# to be used as a shell variable name
# Note: it actually calls tr (translate)
# and translates every alphanumeric character
# into an underscore
function tr_sh() {
 echo $(echo -n "$@" | tr -c [:alnum:] '_')
}

# Transforms the argument, putting '-Xcompiler'
# at the beginning of each word
# -Xlinker arguments are ignored
function put_xcompiler() {
 echo $(echo -n "$@" | \
        tr ' ' '\n' | \
        sed 's/^/-Xcompiler /g' | \
        tr '\n' ' ' | \
        sed 's/\(-Xcompiler \)\+/-Xcompiler /g')
}

# Transforms the argument, putting '-Xlinker'
# at the beginning of each word
# -Wl, arguments are also transformed acordingly
# -Xlinker arguments are ignored
function put_xlinker() {
 echo $(echo -n "$@" | \
        tr ' ' '\n' | \
        sed 's/^/-Xlinker /' | \
        sed '/-Wl\,/,/ / s/-Xlinker -Wl,\|,/ -Xlinker /g' | \
        tr '\n' ' ' | \
        sed 's/\(-Xlinker \)\+/-Xlinker /g')
}

if [ x@cuda@ = xyes ];
then

common_includes="\
-I@abs_top_builddir@ \
-I@abs_top_srcdir@/src/core \
-I@abs_top_srcdir@/src/apis/c \
-I@abs_top_builddir@/src/apis/c \
$END"

VERSIONS="@VERSIONS@"
PLUGINS="@PLUGINS@"

LIBS="-Xlinker --no-as-needed -lnanox-ompss -lnanox -lnanox-c -lnanox-gpu-api -Xlinker --as-needed @cudalibs@"

@is_debug_enabled_TRUE@ debug_CPPFLAGS="@debug_CPPFLAGS@ ${common_includes} @cudainc@ @CPPFLAGS@"
@is_debug_enabled_TRUE@ debug_CXXFLAGS="@debug_CXXFLAGS@ @CXXFLAGS@"
@is_debug_enabled_TRUE@ debug_LDFLAGS="@cudalib@ @LDFLAGS@"
@is_debug_enabled_TRUE@ debug_LIBS=${LIBS}

@is_instrumentation_enabled_TRUE@ instrumentation_CPPFLAGS="@instrumentation_CPPFLAGS@ ${common_includes} @cudainc@ @CPPFLAGS@"
@is_instrumentation_enabled_TRUE@ instrumentation_CXXFLAGS="@instrumentation_CXXFLAGS@ @CXXFLAGS@"
@is_instrumentation_enabled_TRUE@ instrumentation_LDFLAGS="@cudalib@ @LDFLAGS@"
@is_instrumentation_enabled_TRUE@ instrumentation_LIBS=${LIBS}

@is_instrumentation_debug_enabled_TRUE@ instrumentation_debug_CPPFLAGS="@instrumentation_debug_CPPFLAGS@ ${common_includes} @cudainc@ @CPPFLAGS@"
@is_instrumentation_debug_enabled_TRUE@ instrumentation_debug_CXXFLAGS="@instrumentation_debug_CXXFLAGS@ @CXXFLAGS@"
@is_instrumentation_debug_enabled_TRUE@ instrumentation_debug_LDFLAGS="@cudalib@ @LDFLAGS@"
@is_instrumentation_debug_enabled_TRUE@ instrumentation_debug_LIBS=${LIBS}

@is_performance_enabled_TRUE@ performance_CPPFLAGS="@performance_CPPFLAGS@ ${common_includes} @cudainc@ @CPPFLAGS@"
@is_performance_enabled_TRUE@ performance_CXXFLAGS="@performance_CXXFLAGS@ @CXXFLAGS@"
@is_performance_enabled_TRUE@ performance_LDFLAGS="@cudalib@ @LDFLAGS@"
@is_performance_enabled_TRUE@ performance_LIBS=${LIBS}

# Common to all versions
cat << EOF
test_CC=@cuda_prefix@/bin/nvcc
test_CXX=@cuda_prefix@/bin/nvcc
EOF

# Specific to each version
compile_versions=
for version in $VERSIONS; do
 sh_version=$(tr_sh $version)
 compile_versions+="${sh_version} "
 for plugin in $PLUGINS; do
  eval "${sh_version}_LDFLAGS=\"\
-L @abs_top_builddir@/src/${plugin}/${version}/.libs -Wl,-rpath,@abs_top_builddir@/src/${plugin}/${version}/.libs \
\${${sh_version}_LDFLAGS}\""
 done

 eval "${sh_version}_LDFLAGS=\"\
-L @abs_top_builddir@/src/core/${version}/.libs -Wl,-rpath,@abs_top_builddir@/src/core/${version}/.libs \
-L @abs_top_builddir@/src/pms/${version}/.libs -Wl,-rpath,@abs_top_builddir@/src/pms/${version}/.libs \
-L @abs_top_builddir@/src/apis/${version}/.libs -Wl,-rpath,@abs_top_builddir@/src/apis/${version}/.libs \
@PTHREAD_LIBS@ \
\${${sh_version}_LIBS} \
\${${sh_version}_LDFLAGS}\""

# Prepend each preprocessor and compiler flag with -Xcompiler
# Same for linker flags with -Xlinker
# For that purpose, use put_xcompiler and put_xlinker functions declared at the begining of the script.
cat << EOF
test_CPPFLAGS_${sh_version}="$(eval put_xcompiler \${${sh_version}_CPPFLAGS} ${test_CPPFLAGS} )"
test_CFLAGS_${sh_version}="$(eval put_xcompiler \${${sh_version}_CFLAGS} ${test_CFLAGS} )"
test_CXXFLAGS_${sh_version}="$(eval put_xcompiler \${${sh_version}_CXXFLAGS} ${test_CXXFLAGS} )"
test_LDFLAGS_${sh_version}="$(eval put_xlinker \${${sh_version}_LDFLAGS} \${${sh_version}_LIBS} ${test_LDFLAGS} )"
test_PLUGINS_${sh_version}="$(eval echo \${${sh_version}_PLUGINS})"
test_ENV_${sh_version}="$(eval echo \${${sh_version}_ENV} ${test_ENV})"
EOF
done # for version 

cat << EOF
compile_versions="${compile_versions}"
$(@abs_top_srcdir@/tests/gens/config.py -a '--smp-cpus=3 --gpu-max-memory 16777216 --enable-cuda --gpus=2 , --gpu-overlap --gpu-prefetch 4|--gpu-overlap --gpu-prefetch 0' -c 1 $* )
EOF

else
cat << EOF
test_ignore=yes
EOF

fi
