#!/bin/bash

if [ x@cuda@ = xyes ];
then

#common_includes="
#	-I\$SRC/apis/c \
#	-I\$BUILD/apis/c \
#	-I\$SRC/arch/unix-os \
#	-I\$SRC/support \
#	-I\$SRC/core \
#	-I\$SRC/arch/smp \
#	-I\$SRC/arch/gpu \
#	-I\$SRC/arch/spu \
#	-I\$SRC/arch/opencl \
#	-I\$SRC/arch/cluster"

common_includes="\
-I@abs_top_builddir@ \
-I@abs_top_srcdir@/src/core \
-I@abs_top_srcdir@/src/apis/c \
-I@abs_top_builddir@/src/apis/c \
$END"

VERSIONS="@VERSIONS@"
PLUGINS="@PLUGINS@"

@DEBUG_VERSION_TRUE@ debug_CPPFLAGS="@debug_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes @cudainc@"
@DEBUG_VERSION_TRUE@ debug_CXXFLAGS="@extra_CXXFLAGS@"
@DEBUG_VERSION_TRUE@ debug_LDFLAGS="@extra_LDFLAGS@" # @cudalib@"
@DEBUG_VERSION_TRUE@ debug_LIBS="@extra_LIBS@ @cudalibs@"
@DEBUG_VERSION_TRUE@ debug_PLUGINS=

@INSTRUMENTATION_VERSION_TRUE@ instrumentation_CPPFLAGS="@instrumentation_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes @cudainc@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_CXXFLAGS="@instrumentation_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@ @cudalib@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_LIBS="@extra_LIBS@ @cudalibs@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_PLUGINS=

@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_CPPFLAGS="@instrumentation_debug_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes @cudainc@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_CXXFLAGS="@instrumentation_debug_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@ @cudalib@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_LIBS="@extra_LIBS@ @cudalibs@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_PLUGINS=

@PERFORMANCE_VERSION_TRUE@ performance_CPPFLAGS="@performance_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes @cudainc@"
@PERFORMANCE_VERSION_TRUE@ performance_CXXFLAGS="@performance_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@"
@PERFORMANCE_VERSION_TRUE@ performance_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@ @cudalib@"
@PERFORMANCE_VERSION_TRUE@ performance_LIBS="@extra_LIBS@ @cudalibs@"
@PERFORMANCE_VERSION_TRUE@ performance_PLUGINS=

# Common to all versions
cat << EOF
test_CC=@cuda_prefix@/bin/nvcc
test_CXX=@cuda_prefix@/bin/nvcc

compile_versions="@VERSIONS@"
EOF

# Specific to each version
for version in $VERSIONS; do

  for plugin in $PLUGINS; do
    eval ${version}_PLUGINS+="':@abs_top_builddir@/src/$plugin/$version/.libs'"
  done

  eval ${version}_ENV=$(eval echo \'LD_LIBRARY_PATH=\
@abs_top_builddir@/src/core/$version/.libs:\
@abs_top_builddir@/src/apis/$version/.libs:\
@abs_top_builddir@/src/pms/$version/.libs:\
\${${version}_PLUGINS}:$LD_LIBRARY_PATH\')

  eval ${version}_LDFLAGS+="'--no-as-needed \
@abs_top_builddir@/src/pms/${version}/.libs/libnanox-ompss.so \
@abs_top_builddir@/src/core/${version}/.libs/libnanox.so \
@abs_top_builddir@/src/apis/${version}/.libs/libnanox-c.so \
@abs_top_builddir@/src/arch/gpu/${version}/.libs/libnanox-gpu-api.so \
@PTHREAD_LIBS@'"

echo "test_CPPFLAGS_${version}=\"\\"
for cppoption in $(eval echo \${${version}_CPPFLAGS}); do
    echo "  -Xcompiler $cppoption \\"
done
echo '"'

echo "test_CXXFLAGS_${version}=\"\\"
for cppoption in $(eval echo \${${version}_CXXFLAGS}); do
    echo "  -Xcompiler $cxxoption \\"
done
echo '"'

echo "test_LDFLAGS_${version}=\"\\"
for ldoption in $(eval echo \${${version}_LDFLAGS} \${${version}_LIBS}); do
    echo "  -Xlinker $ldoption \\"
done
echo '"'

cat << EOF
test_ENV_${version}="$(eval echo \${${version}_ENV})"

$(@abs_top_srcdir@/tests/gens/config.py $*)
EOF

done # for version 

else
cat << EOF
test_ignore=yes
EOF

fi
