#!/bin/bash

if [ x@MCC_SUPPORT@ = xyes ];
then

#common_includes="-I\$SRC/core -I\$SRC/apis/c -I\$SRC/pms/openmp -I\$SRC/../tests/test/pfm"
common_includes="\
-I@abs_top_builddir@ \
-I@abs_top_srcdir@/src/core \
-I@abs_top_srcdir@/src/apis/c \
-I@abs_top_srcdir@/src/pms/openmp \
-I@abs_top_builddir@/src/apis/c \
$END"

VERSIONS="@VERSIONS@"
PLUGINS="@PLUGINS@"

@DEBUG_VERSION_TRUE@ debug_CPPFLAGS="@debug_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes"
@DEBUG_VERSION_TRUE@ debug_CXXFLAGS="@debug_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@ --debug"
@DEBUG_VERSION_TRUE@ debug_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@"
@DEBUG_VERSION_TRUE@ debug_LIBS="@extra_LIBS@"
@DEBUG_VERSION_TRUE@ debug_PLUGINS=

@INSTRUMENTATION_VERSION_TRUE@ instrumentation_CPPFLAGS="@instrumentation_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_CXXFLAGS="@instrumentation_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@ --instrument"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_LIBS="@extra_LIBS@"
@INSTRUMENTATION_VERSION_TRUE@ instrumentation_PLUGINS=

@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_CPPFLAGS="@instrumentation_debug_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_CXXFLAGS="@instrumentation_debug_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@ --debug --instrument"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_LIBS="@extra_LIBS@"
@INSTRUMENTATION_DEBUG_VERSION_TRUE@ instrumentation_debug_PLUGINS=

@PERFORMANCE_VERSION_TRUE@ performance_CPPFLAGS="@performance_CPPFLAGS@ @cc_dep_CPPFLAGS@ @host_dep_CPPFLAGS@ @extra_CPPFLAGS@ $common_includes"
@PERFORMANCE_VERSION_TRUE@ performance_CXXFLAGS="@performance_CXXFLAGS@ @cc_dep_CXXFLAGS@ @host_dep_CXXFLAGS@ @extra_CXXFLAGS@"
@PERFORMANCE_VERSION_TRUE@ performance_LDFLAGS="@cc_dep_LDFLAGS@ @host_dep_LDFLAGS@ @extra_LDFLAGS@"
@PERFORMANCE_VERSION_TRUE@ performance_LIBS="@extra_LIBS@"
@PERFORMANCE_VERSION_TRUE@ performance_PLUGINS=

# Common to all versions
cat << EOF
test_CC=@MCC@
test_CXX=@MCXX@

compile_versions="@VERSIONS@"
EOF

# Specific to each version
for version in $VERSIONS; do

  for plugin in $PLUGINS; do
    eval ${version}_PLUGINS+="':@abs_top_builddir@/src/$plugin/$version/.libs'"
  done

  eval ${version}_ENV=$(eval echo \'LD_LIBRARY_PATH=\
@abs_top_builddir@/src/core/$version/.libs:\
@abs_top_builddir@/src/apis/$version/.libs:\
@abs_top_builddir@/src/pms/$version/.libs:\
\${${version}_PLUGINS}:$LD_LIBRARY_PATH\')

  eval ${version}_LDFLAGS+="' -Wl,--no-as-needed \
@abs_top_builddir@/src/pms/${version}/.libs/libnanox-omp.so \
@abs_top_builddir@/src/core/${version}/.libs/libnanox.so \
@abs_top_builddir@/src/apis/${version}/.libs/libnanox-c.so \
@PTHREAD_LIBS@ \
-lrt \
-lm'"

cat <<EOF
test_CPPFLAGS_${version}="$(eval echo \${${version}_CPPFLAGS})"
test_CXXFLAGS_${version}="$(eval echo \${${version}_CXXFLAGS}) --openmp"
test_LDFLAGS_${version}="$(eval echo \${${version}_LDFLAGS} \${${version}_LIBS})"
test_PLUGINS_${version}="$(eval echo \${${version}_PLUGINS})"
test_ENV_${version}="$(eval echo \${${version}_ENV})"

$(@abs_top_srcdir@/tests/gens/config.py $*)
EOF
done;

else

cat <<EOF
test_ignore=yes
EOF

fi

